<!-- app/templates/components.html -->
<!-- TODO: fix formatting looks ugly -->

{% extends "base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-white mb-2">Components</h1>
    <p class="text-slate-400 text-base sm:text-lg">Browse all transit technology components. Filter and tap a card to view full details.</p>
  </div>

  <!-- Filters and Search -->
  <div class="glass-effect rounded-xl p-4 sm:p-6 border border-slate-700/50 mb-8">
    <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
      
      <!-- Search and Filters -->
      <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 w-full">
        
        <!-- Search -->
        <div class="relative flex-1 min-w-[220px]">
          <input id="component-search" type="text" placeholder="Search components..." 
                 class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white placeholder-slate-400 focus:border-blue-500 focus:outline-none"
                 hx-get="/api/components/list" hx-target="#components-list" hx-trigger="keyup changed delay:300ms" hx-include="[id='functional-area-filter'],[id='vendor-filter'],[id='agency-filter'],[id='status-filter']" hx-vals='js:{"search": event.target.value}'>
          <svg class="absolute right-3 top-3 w-5 h-5 text-slate-400 pointer-events-none" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
          </svg>
        </div>

        <!-- Functional Area Filter -->
        <select id="functional-area-filter" 
                class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:border-blue-500 focus:outline-none"
                hx-get="/api/components/list" hx-target="#components-list" hx-include="[id='vendor-filter'],[id='agency-filter'],[id='status-filter'],[id='component-search']" hx-vals='js:{"functional_area": event.target.value}'
                hx-trigger="change" hx-swap="innerHTML">
          <option value="">All Functional Areas</option>
        </select>

        <!-- Vendor Filter -->
        <select id="vendor-filter" 
                class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:border-blue-500 focus:outline-none"
                hx-get="/api/components/list" hx-target="#components-list" hx-include="[id='functional-area-filter'],[id='agency-filter'],[id='status-filter'],[id='component-search']" hx-vals='js:{"vendor": event.target.value}'
                hx-trigger="change" hx-swap="innerHTML">
          <option value="">All Vendors</option>
        </select>

        <!-- Agency Filter -->
        <select id="agency-filter" 
                class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:border-blue-500 focus:outline-none"
                hx-get="/api/components/list" hx-target="#components-list" hx-include="[id='functional-area-filter'],[id='vendor-filter'],[id='status-filter'],[id='component-search']" hx-vals='js:{"agency": event.target.value}'
                hx-trigger="change" hx-swap="innerHTML">
          <option value="">All Agencies</option>
        </select>

        <!-- Status Filter -->
        <select id="status-filter" 
                class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:border-blue-500 focus:outline-none"
                hx-get="/api/components/list" hx-target="#components-list" hx-include="[id='functional-area-filter'],[id='vendor-filter'],[id='agency-filter'],[id='component-search']" hx-vals='js:{"status": event.target.value}'
                hx-trigger="change">
          <option value="">All Components</option>
          <option value="no_issues">No Issues</option>
          <option value="issues">Has Issues</option>
        </select>
      </div>

      <!-- Actions -->
      <div class="flex gap-2 w-full lg:w-auto">
        <button class="flex-1 lg:flex-none px-4 py-2.5 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg font-medium hover:from-blue-700 hover:to-cyan-700 transition-all text-white">
          <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          Add Component
        </button>
        <button class="px-4 py-2.5 bg-slate-800 hover:bg-slate-700 rounded-lg font-medium transition-colors text-white">
          Export
        </button>
      </div>
    </div>
  </div>

  <!-- Components Grid (no sidebar) -->
  <div class="glass-effect rounded-xl p-4 sm:p-6 border border-slate-700/50">
    <div class="flex items-center justify-between mb-4 sm:mb-6">
      <h2 class="text-xl sm:text-2xl font-bold text-white">Components</h2>
      <button hx-get="/api/components/list" hx-target="#components-list" 
              class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded text-sm transition-colors text-white">
        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
        </svg>
        Refresh
      </button>
    </div>

    <div id="components-list" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3 sm:gap-4" hx-get="/api/components/list" hx-trigger="load">
      <!-- Cards will load here -->
      <div class="animate-pulse space-y-3">
        <div class="h-24 bg-slate-800 rounded-lg"></div>
        <div class="h-24 bg-slate-800 rounded-lg"></div>
        <div class="h-24 bg-slate-800 rounded-lg"></div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Load filter options on page load
document.addEventListener('DOMContentLoaded', function() {
  htmx.ajax('GET', '/api/filter-options/functional-areas', { target: '#functional-area-filter', swap: 'innerHTML' });
  htmx.ajax('GET', '/api/filter-options/vendors', { target: '#vendor-filter', swap: 'innerHTML' });
  htmx.ajax('GET', '/api/agencies/options', { target: '#agency-filter', swap: 'innerHTML' });
});

// Auto-refresh counts if any present
setInterval(function() {
  const elements = document.querySelectorAll('[hx-get*="/api/count/"]');
  elements.forEach(el => htmx.trigger(el, 'refresh'));
}, 30000);
</script>
{% endblock %}