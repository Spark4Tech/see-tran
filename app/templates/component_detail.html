{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <a href="/components" class="inline-flex items-center text-slate-300 hover:text-white text-sm mb-6">
    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4A1 1 0 018.707 6.707L6.414 9H17a1 1 0 110 2H6.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>
    Back to Components
  </a>

  <div class="flex items-start justify-between mb-4 gap-4">
    <div class="flex items-center flex-wrap gap-2">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-white leading-tight">{{ component.name }}</h1>
      {% if component.is_composite %}
        <span class="px-2 py-1 bg-blue-600/20 border border-blue-600/30 rounded text-xs text-blue-300">Composite</span>
      {% endif %}
    </div>
    <div class="flex items-center gap-2 shrink-0">
      <button
        hx-get="/api/components/{{ component.id }}/form"
        hx-target="#component-form-container"
        hx-swap="innerHTML"
        class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs sm:text-sm text-white border border-slate-600/60 transition-colors">
        Edit
      </button>
      <button id="delete-component-btn"
              data-component-id="{{ component.id }}"
              class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-xs sm:text-sm text-white border border-red-600/60 transition-colors">
        Delete
      </button>
    </div>
  </div>

  <!-- Inline form container (appears when editing) -->
  <div id="component-form-container" class="mb-8"></div>

  <div class="grid grid-cols-1 gap-6">
    <!-- Key facts -->
    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-base">
        <div class="space-y-1">
          <p class="text-slate-400">Version</p>
          <p class="text-white font-medium text-lg">{{ component.version or 'Unknown' }}</p>
        </div>
        <div class="space-y-1">
          <p class="text-slate-400">Deployment Date</p>
          <p class="text-white font-medium text-lg">{{ component.deployment_date.strftime('%B %d, %Y') if component.deployment_date else 'Unknown' }}</p>
        </div>
        <div class="space-y-1">
          <p class="text-slate-400">Update Frequency</p>
          <p class="text-white font-medium text-lg">{{ component.update_frequency or 'Unknown' }}</p>
        </div>
        <div class="space-y-1">
          <p class="text-slate-400">Vendor</p>
          <p class="text-white font-medium text-lg">{{ component.vendor.name if component.vendor else 'No Vendor' }}</p>
        </div>
      </div>
      {% if component.known_issues %}
      <div class="mt-6 bg-red-900/20 border border-red-700/30 rounded p-4">
        <h3 class="text-red-300 font-semibold mb-2">Known Issues</h3>
        <p class="text-red-200">{{ component.known_issues }}</p>
      </div>
      {% else %}
      <div class="mt-6 bg-green-900/20 border border-green-700/30 rounded p-4">
        <h3 class="text-green-300 font-semibold mb-2">Status</h3>
        <p class="text-green-200">No known issues</p>
      </div>
      {% endif %}
    </div>

    <!-- Implementations by Agency -->
    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <h2 class="text-2xl font-bold text-white mb-4">Agency Implementations</h2>
      {% if implementations_by_agency %}
        <div class="space-y-4">
          {% for agency_name, impls in implementations_by_agency.items() %}
            <div>
              <h3 class="text-blue-300 font-semibold mb-2">{{ agency_name }}</h3>
              <div class="space-y-2">
                {% for impl in impls %}
                  <div class="flex items-center justify-between p-3 bg-slate-700/30 rounded">
                    <div class="flex items-center space-x-2">
                      <span class="w-2 h-2 rounded-full {{ 'bg-green-500' if impl.status == 'Active' else 'bg-yellow-500' }}"></span>
                      <span class="text-slate-200">{{ impl.function.name }}</span>
                      <span class="text-slate-400 text-xs">({{ impl.function.functional_area.name }})</span>
                    </div>
                    <div class="text-right">
                      <span class="text-xs text-slate-400">{{ impl.deployment_date.strftime('%Y-%m-%d') if impl.deployment_date else 'No date' }}</span>
                      {% if impl.version %}
                        <br><span class="text-xs text-slate-500">v{{ impl.version }}</span>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-slate-400">No agency usage tracked for this component.</p>
      {% endif %}
    </div>

    <!-- Integrations -->
    <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
      <h2 class="text-2xl font-bold text-white mb-4">Integrations</h2>
      {% if integrations %}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {% for ip in integrations %}
            <div class="p-3 bg-slate-700/30 rounded">
              <div class="flex items-center justify-between">
                <span class="text-slate-200">{{ ip.name }}</span>
                <span class="text-xs text-slate-400">{{ ip.integration_type or 'Standard' }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-slate-400">No integrations configured.</p>
      {% endif %}
    </div>

    <!-- Additional Metadata -->
    {% if component.additional_metadata %}
      <div class="glass-effect rounded-xl p-6 border border-slate-700/50">
        <h2 class="text-2xl font-bold text-white mb-4">Additional Information</h2>
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {% for key, value in component.additional_metadata.items() %}
          <div>
            <dt class="text-slate-400">{{ key.replace('_', ' ').title() }}</dt>
            <dd class="text-white font-medium">{{ value }}</dd>
          </div>
          {% endfor %}
        </dl>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Delete component (full detail page)
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'delete-component-btn'){
    const btn = e.target;
    const id = btn.dataset.componentId;
    if(!confirm('Delete this component? This cannot be undone.')) return;
    btn.disabled = true; const original = btn.textContent; btn.textContent='Deleting...';
    fetch(`/api/components/${id}`, { method:'DELETE' })
      .then(r=>r.json())
      .then(data=>{
        showToast(data.message, data.status==='success');
        if(data.status==='success'){
          window.location = '/components';
        } else {
          btn.disabled=false; btn.textContent=original;
        }
      })
      .catch(()=>{ showToast('Delete failed', false); btn.disabled=false; btn.textContent=original; });
  }
});
</script>
{% endblock %}
